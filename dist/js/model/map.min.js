var Direction,Map,Point,Tile,Tilemap,extend=function(t,e){function i(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,slice=[].slice;Tile={EMPTY:0,OCCUPIED:1,GROUND:1,WALL:-1,DOOR:-2,FIRST_ROOM:2,TREASURE_ROOM:3,SECRET_ROOM:4},Direction={NORTH:0,EAST:1,SOUTH:2,WEST:3},Point=function(t){function e(){var t,e,i,r;for(r=1<=arguments.length?slice.call(arguments,0):[],t=0,e=r.length;e>t;t++)i=r[t],this.push(i)}return extend(e,t),Object.defineProperty(e.prototype,"x",{get:function(){return this[0]},set:function(t){for(;!this.length>0;)this.push(null);return this[0]=t}}),Object.defineProperty(e.prototype,"y",{get:function(){return this[1]},set:function(t){for(;!this.length>1;)this.push(null);return this[1]=t}}),Object.defineProperty(e.prototype,"z",{get:function(){return this[2]},set:function(t){for(;!this.length>2;)this.push(null);return this[2]=t}}),e}(Array),Tilemap=function(t){function e(t,e,i){var r,n,o,h;for(null==i&&(i=null),r=o=0,h=t;h>=0?h>o:o>h;r=h>=0?++o:--o)this.push(function(){var t,r,o;for(o=[],n=t=0,r=e;r>=0?r>t:t>r;n=r>=0?++t:--t)o.push(i);return o}())}return extend(e,t),Object.defineProperty(e.prototype,"width",{get:function(){return this.length}}),Object.defineProperty(e.prototype,"height",{get:function(){return this[0].length}}),e.prototype.get=function(t,e,i,r){var n,o,h,s,u,l;for(null==i&&(i=1),null==r&&(r=1),l=[],n=h=s=t,u=t+i;u>=s?u>h:h>u;n=u>=s?++h:--h)l.push(function(){var t,i,h,s;for(s=[],o=t=i=e,h=e+r;h>=i?h>t:t>h;o=h>=i?++t:--t)s.push(this[n][o]);return s}.call(this));return l},e.prototype.set=function(t,e,i,r,n){var o,h,s,u,l,p;for(null==i&&(i=1),null==r&&(r=1),p=[],o=s=u=t,l=t+i;l>=u?l>s:s>l;o=l>=u?++s:--s)p.push(function(){var t,i,s,u;for(u=[],h=t=i=e,s=e+r;s>=i?s>t:t>s;h=s>=i?++t:--t)u.push(this[o][h]=n);return u}.call(this));return p},e.prototype.is=function(t,e,i,r,n){var o,h,s,u,l,p,c,f;if(null==i&&(i=1),null==r&&(r=1),t+i>this.width||e+r>this.height||0>t||0>e)return!1;for(o=s=l=t,p=t+i;p>=l?p>s:s>p;o=p>=l?++s:--s)for(h=u=c=e,f=e+r;f>=c?f>u:u>f;h=f>=c?++u:--u)if(this[o][h]!==n)return!1;return!0},e.prototype.setWidth=function(t,e){var i;if(null==e&&(e=null),t>this.width)for(;t>this.width;)this.push(function(){var t,r,n;for(n=[],i=t=0,r=this.height;r>=0?r>t:t>r;i=r>=0?++t:--t)n.push(e);return n}.call(this));else this.splice(t,this.width-t);return this.width},e.prototype.setHeight=function(t,e){var i,r,n;for(null==e&&(e=null),n=i=0,r=this.width;r>=0?r>i:i>r;n=r>=0?++i:--i)if(t>this.height)for(;t>this[n].width;)this[n].push(e);else this.splice(t,this.height-t);return this[0].height},e.prototype.clone=function(){var t,i,r,n,o,h,s,u,l;for(o=new e(this.width,this.height),u=t=0,r=this.length;r>t;u=++t)for(h=this[u],l=i=0,n=h.length;n>i;l=++i)s=h[l],o[u][l]=s;return o},e}(Array),Map=function(){function t(t,e,i){this.width=t,this.height=e,this.roomList=i}var e;return t.prototype.getTilemap=function(t){var i,r,n,o,h,s;for(t++,s=new Tilemap(this.width*t+1,this.height*t+1,Tile.EMPTY),o=this.roomList,i=r=0,n=o.length;n>r;i=++r)h=o[i],e(h,s,t);return s},e=function(t,e,i){var r,n,o,h,s,u,l,p,c,f;for(l=new Point(t.x*i,t.y*i),f=t.width*i,o=t.height*i,"first room"===t.special?e.set(l[0]+1,l[1]+1,f,o,Tile.FIRST_ROOM):"treasure room"===t.special?e.set(l[0]+1,l[1]+1,f,o,Tile.TREASURE_ROOM):"secret room"===t.special?e.set(l[0]+1,l[1]+1,f,o,Tile.SECRET_ROOM):e.set(l[0]+1,l[1]+1,f,o,Tile.GROUND),e.set(l[0],l[1],f+1,1,Tile.WALL),e.set(l[0],l[1]+o,f+1,1,Tile.WALL),e.set(l[0]+f,l[1],1,o+1,Tile.WALL),e.set(l[0],l[1],1,o+1,Tile.WALL),p=t.neighbours,c=[],r=h=0,s=p.length;s>h;r=++h)if(u=p[r],null!=u)switch(n=Math.floor(r/4)*i+Math.floor(i/2),r%4){case Direction.NORTH:c.push(e[l[0]+n][l[1]]=Tile.DOOR);break;case Direction.SOUTH:c.push(e[l[0]+n][l[1]+o]=Tile.DOOR);break;case Direction.EAST:c.push(e[l[0]+f][l[1]+n]=Tile.DOOR);break;case Direction.WEST:c.push(e[l[0]][l[1]+n]=Tile.DOOR);break;default:c.push(void 0)}return c},t}(),window.Tile=Tile,window.Direction=Direction,window.Point=Point,window.Tilemap=Tilemap,window.Map=Map;