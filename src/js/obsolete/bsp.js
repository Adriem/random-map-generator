var Tree, cfg, generateDoors, generateMap, generatePaths, generateRooms, spawnRoom, split;

cfg = {
  RATIO_RESTR: 0.45,
  PARTITION_LEVEL: 2,
  ROOM_REDUCTION: 0.3,
  MIN_ROOM_SIZE: 5,
  MAX_ROOM_SIZE: 20,
  MIN_SECTOR_REDUCTION: 2,
  MIN_SECTOR_SIZE: 10,
  MAX_SECTOR_SIZE: 24,
  BIG_ROOM_CHANCE: 60,
  ROOM_DELETING_RATIO: 0.4,
  DOOR_CHANCE: 100
};

Tree = (function() {
  function Tree(node1) {
    this.node = node1;
    this.childs = [];
  }

  Tree.prototype.isEmpty = function() {
    return this.node == null;
  };

  Tree.prototype.isLeaf = function() {
    return this.childs.length === 0;
  };

  Tree.prototype.getLeafs = function() {
    var child, k, len, ref, retVal;
    if (this.isLeaf()) {
      return [this];
    }
    retVal = [];
    ref = this.childs;
    for (k = 0, len = ref.length; k < len; k++) {
      child = ref[k];
      retVal = retVal.concat(child.getLeafs());
    }
    return retVal;
  };

  Tree.prototype.getNodeList = function() {
    var child, k, len, ref, retVal;
    retVal = [this.node];
    ref = this.childs;
    for (k = 0, len = ref.length; k < len; k++) {
      child = ref[k];
      retVal = retVal.concat(child.getNodeList());
    }
    return retVal;
  };

  Tree.prototype.kill = function() {
    this.childs = [];
    return this.node = void 0;
  };

  Tree.prototype.removeDeadLeafs = function() {
    var child, i, k, ref;
    if (!this.isLeaf()) {
      ref = this.childs;
      for (i = k = ref.length - 1; k >= 0; i = k += -1) {
        child = ref[i];
        child.removeDeadLeafs();
        if (child.isLeaf() && child.isEmpty()) {
          this.childs.splice(i, 1);
        }
      }
    }
    return void 0;
  };

  Tree.prototype.grow = function(splitFunction) {
    var childNodes, k, len, node, ref;
    childNodes = splitFunction(this.node);
    if ((childNodes != null) && (0 < (ref = childNodes.length) && ref <= 1)) {
      this.node = childNodes[0];
    } else if ((childNodes != null) && childNodes.length > 1) {
      for (k = 0, len = childNodes.length; k < len; k++) {
        node = childNodes[k];
        this.childs.push(new Tree(node).grow(splitFunction));
      }
    }
    return this;
  };

  Tree.prototype.paint = function(c) {
    var child, k, len, ref, results, tileSize;
    tileSize = TILE_SIZE();
    c.beginPath();
    c.strokeStyle = "#0f0";
    c.lineWidth = 6;
    c.strokeRect(this.node.x * tileSize, this.node.y * tileSize, this.node.w * tileSize, this.node.h * tileSize);
    ref = this.childs;
    results = [];
    for (k = 0, len = ref.length; k < len; k++) {
      child = ref[k];
      results.push(child.paint(c));
    }
    return results;
  };

  return Tree;

})();

generateMap = function(size) {
  var paths, rooms, tilemap, tree;
  cfg.MIN_SECTOR_SIZE = cfg.MIN_ROOM_SIZE * 2;
  cfg.MAX_SECTOR_SIZE = cfg.MAX_ROOM_SIZE + 2 * cfg.MIN_SECTOR_REDUCTION;
  tilemap = new TileMap(size, size);
  tree = new Tree(new Rect(0, 0, size, size)).grow(split);
  rooms = generateRooms(tree, tilemap);
  tree.removeDeadLeafs();
  paths = generatePaths(tree, tilemap);
  tilemap.removeDeadEnds();
  generateDoors(tilemap.tilemap);
  tilemap.optimiseDoors();
  tilemap.drawWalls();
  tilemap.debug.tree = tree;
  return tilemap;
};

spawnRoom = function(sector) {
  var h, w, x, y;
  if (sector.w < sector.h) {
    w = random.value(cfg.MIN_ROOM_SIZE, sector.w - 2 * cfg.MIN_SECTOR_REDUCTION);
    h = sector.h - (sector.w - w);
  } else {
    h = random.value(cfg.MIN_ROOM_SIZE, sector.h - 2 * cfg.MIN_SECTOR_REDUCTION);
    w = sector.w - (sector.h - h);
  }
  x = sector.x + Math.floor((sector.w - w) / 2);
  y = sector.y - sector.x + x;
  return new Rect(x, y, w, h);
};

generateRooms = function(tree, tilemap) {
  var i, index, k, l, leaf, leafs, len, ref, rooms, roomsToDelete, x;
  rooms = [];
  leafs = tree.getLeafs();
  roomsToDelete = Math.round(leafs.length * cfg.ROOM_DELETING_RATIO);
  for (x = k = 0, ref = roomsToDelete; 0 <= ref ? k < ref : k > ref; x = 0 <= ref ? ++k : --k) {
    index = random.value(leafs.length);
    leafs[index].kill();
    leafs.splice(index, 1);
  }
  for (i = l = 0, len = leafs.length; l < len; i = ++l) {
    leaf = leafs[i];
    rooms[i] = spawnRoom(leaf.node);
    tilemap.drawRect(rooms[i]);
  }
  return rooms;
};

generatePaths = function(tree, tilemap) {
  var _, i, k, l, len, len1, path, paths, sectorList;
  paths = [];
  sectorList = tree.getNodeList();
  for (i = k = 0, len = sectorList.length; k < len; i = ++k) {
    _ = sectorList[i];
    paths.push(new Path(sectorList[i].center, sectorList[(i + 1) % sectorList.length].center));
  }
  for (l = 0, len1 = paths.length; l < len1; l++) {
    path = paths[l];
    tilemap.drawPath(path);
  }
  return paths;
};

generateDoors = function(tilemap) {
  var LOOKAHEAD, doors, i, j, k, l, m, n, o, p, q, ref, ref1, ref10, ref11, ref2, ref3, ref4, ref5, ref6, ref7, ref8, ref9, total;
  LOOKAHEAD = 3;
  doors = [];
  for (i = k = ref = LOOKAHEAD, ref1 = tilemap.length - LOOKAHEAD; ref <= ref1 ? k < ref1 : k > ref1; i = ref <= ref1 ? ++k : --k) {
    for (j = l = ref2 = LOOKAHEAD, ref3 = tilemap[i].length - LOOKAHEAD; ref2 <= ref3 ? l < ref3 : l > ref3; j = ref2 <= ref3 ? ++l : --l) {
      if (!(tilemap[i][j] === tile.GROUND)) {
        continue;
      }
      total = [0, 0, 0, 0];
      if ((tilemap[i - 1][j] === (ref4 = tilemap[i + 1][j]) && ref4 === tile.NULL) && (tilemap[i][j - 1] === (ref5 = tilemap[i][j + 1]) && ref5 === tile.GROUND)) {
        for (n = m = ref6 = -LOOKAHEAD; ref6 <= -1 ? m <= -1 : m >= -1; n = ref6 <= -1 ? ++m : --m) {
          if (tilemap[i - 1][j + n] !== tile.NULL) {
            total[0]++;
          }
          if (tilemap[i + 1][j + n] !== tile.NULL) {
            total[1]++;
          }
        }
        for (n = o = 1, ref7 = LOOKAHEAD; 1 <= ref7 ? o <= ref7 : o >= ref7; n = 1 <= ref7 ? ++o : --o) {
          if (tilemap[i - 1][j + n] !== tile.NULL) {
            total[2]++;
          }
          if (tilemap[i + 1][j + n] !== tile.NULL) {
            total[3]++;
          }
        }
      } else if ((tilemap[i][j - 1] === (ref8 = tilemap[i][j + 1]) && ref8 === tile.NULL) && (tilemap[i - 1][j] === (ref9 = tilemap[i + 1][j]) && ref9 === tile.GROUND)) {
        for (n = p = ref10 = -LOOKAHEAD; ref10 <= -1 ? p <= -1 : p >= -1; n = ref10 <= -1 ? ++p : --p) {
          if (tilemap[i + n][j - 1] !== tile.NULL) {
            total[0]++;
          }
          if (tilemap[i + n][j + 1] !== tile.NULL) {
            total[1]++;
          }
        }
        for (n = q = 1, ref11 = LOOKAHEAD; 1 <= ref11 ? q <= ref11 : q >= ref11; n = 1 <= ref11 ? ++q : --q) {
          if (tilemap[i + n][j - 1] !== tile.NULL) {
            total[2]++;
          }
          if (tilemap[i + n][j + 1] !== tile.NULL) {
            total[3]++;
          }
        }
      }
      if ((total[0] >= LOOKAHEAD || total[1] >= LOOKAHEAD || total[2] >= LOOKAHEAD || total[3] >= LOOKAHEAD) && random.test(cfg.DOOR_CHANCE)) {
        tilemap[i][j] = tile.DOOR;
        doors.push(new Point(j, i));
      }
    }
  }
  return doors;
};

split = function(sector, horizontalDir, steps) {
  var div1, div2, restriction;
  if (horizontalDir == null) {
    horizontalDir = random.test();
  }
  if (steps == null) {
    steps = cfg.PARTITION_LEVEL;
  }
  if (horizontalDir) {
    if (sector.h / sector.w < 2 * cfg.RATIO_RESTR) {
      return split(sector, !horizontalDir, steps);
    } else if ((steps === 0) || (sector.h < 2 * cfg.MIN_SECTOR_SIZE) || (sector.h < cfg.MAX_SECTOR_SIZE && random.test(cfg.BIG_ROOM_CHANCE))) {
      return [sector];
    } else {
      restriction = Math.max(cfg.MIN_SECTOR_SIZE, Math.ceil(sector.h * cfg.RATIO_RESTR));
      div1 = new Rect(sector.x, sector.y, sector.w, random.value(restriction, sector.h - restriction));
      div2 = new Rect(sector.x, sector.y + div1.h, sector.w, sector.h - div1.h);
    }
  } else {
    if (sector.w / sector.h < 2 * cfg.RATIO_RESTR) {
      return split(sector, !horizontalDir, steps);
    } else if ((steps === 0) || (sector.w < 2 * cfg.MIN_SECTOR_SIZE) || (sector.w < cfg.MAX_SECTOR_SIZE && random.test(cfg.BIG_ROOM_CHANCE))) {
      return [sector];
    } else {
      restriction = Math.max(cfg.MIN_SECTOR_SIZE, Math.ceil(sector.w * cfg.RATIO_RESTR));
      div1 = new Rect(sector.x, sector.y, random.value(restriction, sector.w - restriction), sector.h);
      div2 = new Rect(sector.x + div1.w, sector.y, sector.w - div1.w, sector.h);
    }
  }
  return split(div1, !horizontalDir, steps - 1).concat(split(div2, !horizontalDir, steps - 1));
};


/* EXPORT */

this.bsp = {
  config: cfg,
  generate: generateMap,
  Tree: Tree
};

//# sourceMappingURL=data:application/json;base64,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RUFBQSxNQUFBLEVBQVEsR0FBUjtFQUNBLFFBQUEsRUFBVSxXQURWO0VBRUEsSUFBQSxFQUFNLElBRk4iLCJmaWxlIjoib2Jzb2xldGUvYnNwLmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiY2ZnID1cclxuICBSQVRJT19SRVNUUjogMC40NVxyXG4gIFBBUlRJVElPTl9MRVZFTDogMlxyXG4gIFJPT01fUkVEVUNUSU9OOiAwLjNcclxuICBNSU5fUk9PTV9TSVpFOiA1XHJcbiAgTUFYX1JPT01fU0laRTogMjBcclxuICBNSU5fU0VDVE9SX1JFRFVDVElPTjogMlxyXG4gIE1JTl9TRUNUT1JfU0laRTogMTBcclxuICBNQVhfU0VDVE9SX1NJWkU6IDI0XHJcbiAgQklHX1JPT01fQ0hBTkNFOiA2MFxyXG4gIFJPT01fREVMRVRJTkdfUkFUSU86IDAuNFxyXG4gIERPT1JfQ0hBTkNFOiAxMDBcclxuXHJcbmNsYXNzIFRyZWVcclxuICBjb25zdHJ1Y3RvcjogKEBub2RlKSAtPlxyXG4gICAgQGNoaWxkcyA9IFtdXHJcblxyXG4gIGlzRW1wdHk6IC0+XHJcbiAgICBub3QgQG5vZGU/XHJcblxyXG4gIGlzTGVhZjogLT5cclxuICAgIEBjaGlsZHMubGVuZ3RoIGlzIDBcclxuXHJcbiAgZ2V0TGVhZnM6IC0+XHJcbiAgICByZXR1cm4gW0BdIGlmIEBpc0xlYWYoKVxyXG4gICAgcmV0VmFsID0gW11cclxuICAgIHJldFZhbCA9IHJldFZhbC5jb25jYXQoY2hpbGQuZ2V0TGVhZnMoKSkgZm9yIGNoaWxkIGluIEBjaGlsZHNcclxuICAgIHJldFZhbFxyXG5cclxuICBnZXROb2RlTGlzdDogLT5cclxuICAgIHJldFZhbCA9IFtAbm9kZV1cclxuICAgIHJldFZhbCA9IHJldFZhbC5jb25jYXQgY2hpbGQuZ2V0Tm9kZUxpc3QoKSBmb3IgY2hpbGQgaW4gQGNoaWxkc1xyXG4gICAgcmV0VmFsXHJcblxyXG4gIGtpbGw6IC0+XHJcbiAgICBAY2hpbGRzID0gW11cclxuICAgIEBub2RlID0gdW5kZWZpbmVkXHJcblxyXG4gIHJlbW92ZURlYWRMZWFmczogLT5cclxuICAgIHVubGVzcyBAaXNMZWFmKClcclxuICAgICAgZm9yIGNoaWxkLCBpIGluIEBjaGlsZHMgYnkgLTFcclxuICAgICAgICBjaGlsZC5yZW1vdmVEZWFkTGVhZnMoKVxyXG4gICAgICAgIEBjaGlsZHMuc3BsaWNlIGksIDEgaWYgY2hpbGQuaXNMZWFmKCkgYW5kIGNoaWxkLmlzRW1wdHkoKVxyXG4gICAgdW5kZWZpbmVkICMgQXZvaWRpbmcgcHVzaCBvcGVyYXRpb25zIGFuZCB3cm9uZyByZXR1cm5cclxuXHJcbiAgZ3JvdzogKHNwbGl0RnVuY3Rpb24pIC0+XHJcbiAgICBjaGlsZE5vZGVzID0gc3BsaXRGdW5jdGlvbihAbm9kZSlcclxuICAgIGlmIGNoaWxkTm9kZXM/IGFuZCAwIDwgY2hpbGROb2Rlcy5sZW5ndGggPD0gMVxyXG4gICAgICBAbm9kZSA9IGNoaWxkTm9kZXNbMF1cclxuICAgICAgIyByZXRWYWwgPSBAZ3JvdyhpdGVyYXRpb25zLTEsIHNwbGl0RnVuY3Rpb24pXHJcbiAgICBlbHNlIGlmIGNoaWxkTm9kZXM/IGFuZCBjaGlsZE5vZGVzLmxlbmd0aCA+IDFcclxuICAgICAgZm9yIG5vZGUgaW4gY2hpbGROb2Rlc1xyXG4gICAgICAgIEBjaGlsZHMucHVzaChuZXcgVHJlZShub2RlKS5ncm93KHNwbGl0RnVuY3Rpb24pKVxyXG4gICAgcmV0dXJuIHRoaXNcclxuXHJcbiAgcGFpbnQ6IChjKSAtPlxyXG4gICAgdGlsZVNpemUgPSBUSUxFX1NJWkUoKVxyXG4gICAgYy5iZWdpblBhdGgoKVxyXG4gICAgYy5zdHJva2VTdHlsZSA9IFwiIzBmMFwiXHJcbiAgICBjLmxpbmVXaWR0aCA9IDZcclxuICAgIGMuc3Ryb2tlUmVjdChAbm9kZS54ICogdGlsZVNpemUsIEBub2RlLnkgKiB0aWxlU2l6ZSxcclxuICAgICAgQG5vZGUudyAqIHRpbGVTaXplLCBAbm9kZS5oICogdGlsZVNpemUpXHJcbiAgICBjaGlsZC5wYWludChjKSBmb3IgY2hpbGQgaW4gQGNoaWxkc1xyXG5cclxuZ2VuZXJhdGVNYXAgPSAoc2l6ZSkgLT5cclxuICBjZmcuTUlOX1NFQ1RPUl9TSVpFID0gY2ZnLk1JTl9ST09NX1NJWkUgKiAyXHJcbiAgY2ZnLk1BWF9TRUNUT1JfU0laRSA9IGNmZy5NQVhfUk9PTV9TSVpFICsgMiAqIGNmZy5NSU5fU0VDVE9SX1JFRFVDVElPTlxyXG4gIHRpbGVtYXAgPSBuZXcgVGlsZU1hcChzaXplLCBzaXplKVxyXG4gIHRyZWUgPSBuZXcgVHJlZShuZXcgUmVjdCgwLCAwLCBzaXplLCBzaXplKSkuZ3JvdyhzcGxpdClcclxuICByb29tcyA9IGdlbmVyYXRlUm9vbXModHJlZSwgdGlsZW1hcClcclxuICB0cmVlLnJlbW92ZURlYWRMZWFmcygpXHJcbiAgcGF0aHMgPSBnZW5lcmF0ZVBhdGhzKHRyZWUsIHRpbGVtYXApXHJcbiAgdGlsZW1hcC5yZW1vdmVEZWFkRW5kcygpXHJcbiAgZ2VuZXJhdGVEb29ycyh0aWxlbWFwLnRpbGVtYXApXHJcbiAgdGlsZW1hcC5vcHRpbWlzZURvb3JzKClcclxuICB0aWxlbWFwLmRyYXdXYWxscygpXHJcbiAgdGlsZW1hcC5kZWJ1Zy50cmVlID0gdHJlZVxyXG4gIHRpbGVtYXBcclxuXHJcbnNwYXduUm9vbSA9IChzZWN0b3IpIC0+XHJcbiAgaWYgc2VjdG9yLncgPCBzZWN0b3IuaFxyXG4gICAgdyA9IHJhbmRvbS52YWx1ZShjZmcuTUlOX1JPT01fU0laRSwgc2VjdG9yLncgLSAyKmNmZy5NSU5fU0VDVE9SX1JFRFVDVElPTilcclxuICAgIGggPSBzZWN0b3IuaCAtIChzZWN0b3IudyAtIHcpXHJcbiAgZWxzZVxyXG4gICAgaCA9IHJhbmRvbS52YWx1ZShjZmcuTUlOX1JPT01fU0laRSwgc2VjdG9yLmggLSAyKmNmZy5NSU5fU0VDVE9SX1JFRFVDVElPTilcclxuICAgIHcgPSBzZWN0b3IudyAtIChzZWN0b3IuaCAtIGgpXHJcbiAgeCA9IHNlY3Rvci54ICsgKHNlY3Rvci53IC0gdykgLy8gMlxyXG4gIHkgPSBzZWN0b3IueSAtIHNlY3Rvci54ICsgeFxyXG4gIG5ldyBSZWN0IHgsIHksIHcsIGhcclxuXHJcbmdlbmVyYXRlUm9vbXMgPSAodHJlZSwgdGlsZW1hcCkgLT5cclxuICByb29tcyA9IFtdXHJcbiAgbGVhZnMgPSB0cmVlLmdldExlYWZzKClcclxuICByb29tc1RvRGVsZXRlID0gTWF0aC5yb3VuZChsZWFmcy5sZW5ndGggKiBjZmcuUk9PTV9ERUxFVElOR19SQVRJTylcclxuICAjIERlbGV0ZSBzb21lIHJvb21zXHJcbiAgZm9yIHggaW4gWzAuLi5yb29tc1RvRGVsZXRlXVxyXG4gICAgaW5kZXggPSByYW5kb20udmFsdWUobGVhZnMubGVuZ3RoKVxyXG4gICAgbGVhZnNbaW5kZXhdLmtpbGwoKVxyXG4gICAgbGVhZnMuc3BsaWNlKGluZGV4LCAxKVxyXG4gICMgR2VuZXJhdGUgcm9vbXNcclxuICBmb3IgbGVhZiwgaSBpbiBsZWFmc1xyXG4gICAgcm9vbXNbaV0gPSBzcGF3blJvb20obGVhZi5ub2RlKVxyXG4gICAgdGlsZW1hcC5kcmF3UmVjdChyb29tc1tpXSlcclxuICByb29tc1xyXG5cclxuZ2VuZXJhdGVQYXRocyA9ICh0cmVlLCB0aWxlbWFwKSAtPlxyXG4gIHBhdGhzID0gW11cclxuICBzZWN0b3JMaXN0ID0gdHJlZS5nZXROb2RlTGlzdCgpXHJcbiAgIyBDb25uZWN0IGFsbCBub2Rlc1xyXG4gIGZvciBfLCBpIGluIHNlY3Rvckxpc3RcclxuICAgIHBhdGhzLnB1c2gobmV3IFBhdGgoc2VjdG9yTGlzdFtpXS5jZW50ZXIsXHJcbiAgICAgIHNlY3Rvckxpc3RbKGkrMSkgJSBzZWN0b3JMaXN0Lmxlbmd0aF0uY2VudGVyKSlcclxuICAjIFBhaW50IHBhdGhzXHJcbiAgdGlsZW1hcC5kcmF3UGF0aChwYXRoKSBmb3IgcGF0aCBpbiBwYXRoc1xyXG4gIHBhdGhzXHJcblxyXG5nZW5lcmF0ZURvb3JzID0gKHRpbGVtYXApIC0+XHJcbiAgTE9PS0FIRUFEID0gM1xyXG4gIGRvb3JzID0gW11cclxuICBmb3IgaSBpbiBbTE9PS0FIRUFELi4udGlsZW1hcC5sZW5ndGgtTE9PS0FIRUFEXVxyXG4gICAgZm9yIGogaW4gW0xPT0tBSEVBRC4uLnRpbGVtYXBbaV0ubGVuZ3RoLUxPT0tBSEVBRF0gd2hlbiB0aWxlbWFwW2ldW2pdIGlzIHRpbGUuR1JPVU5EXHJcbiAgICAgIHRvdGFsID0gWzAsMCwwLDBdXHJcbiAgICAgICMgSG9yaXpvbnRhbCBkaXJlY3Rpb25cclxuICAgICAgaWYgdGlsZW1hcFtpLTFdW2pdIGlzIHRpbGVtYXBbaSsxXVtqXSBpcyB0aWxlLk5VTEwgYW5kXHJcbiAgICAgICAgICB0aWxlbWFwW2ldW2otMV0gaXMgdGlsZW1hcFtpXVtqKzFdIGlzIHRpbGUuR1JPVU5EXHJcbiAgICAgICAgZm9yIG4gaW4gWy1MT09LQUhFQUQuLi0xXVxyXG4gICAgICAgICAgdG90YWxbMF0rKyBpZiB0aWxlbWFwW2ktMV1baituXSBpc250IHRpbGUuTlVMTFxyXG4gICAgICAgICAgdG90YWxbMV0rKyBpZiB0aWxlbWFwW2krMV1baituXSBpc250IHRpbGUuTlVMTFxyXG4gICAgICAgIGZvciBuIGluIFsxLi5MT09LQUhFQURdXHJcbiAgICAgICAgICB0b3RhbFsyXSsrIGlmIHRpbGVtYXBbaS0xXVtqK25dIGlzbnQgdGlsZS5OVUxMXHJcbiAgICAgICAgICB0b3RhbFszXSsrIGlmIHRpbGVtYXBbaSsxXVtqK25dIGlzbnQgdGlsZS5OVUxMXHJcbiAgICAgICMgVmVydGljYWwgZGlyZWN0aW9uXHJcbiAgICAgIGVsc2UgaWYgdGlsZW1hcFtpXVtqLTFdIGlzIHRpbGVtYXBbaV1baisxXSBpcyB0aWxlLk5VTEwgYW5kXHJcbiAgICAgICAgICB0aWxlbWFwW2ktMV1bal0gaXMgdGlsZW1hcFtpKzFdW2pdIGlzIHRpbGUuR1JPVU5EXHJcbiAgICAgICAgZm9yIG4gaW4gWy1MT09LQUhFQUQuLi0xXVxyXG4gICAgICAgICAgdG90YWxbMF0rKyBpZiB0aWxlbWFwW2krbl1bai0xXSBpc250IHRpbGUuTlVMTFxyXG4gICAgICAgICAgdG90YWxbMV0rKyBpZiB0aWxlbWFwW2krbl1baisxXSBpc250IHRpbGUuTlVMTFxyXG4gICAgICAgIGZvciBuIGluIFsxLi5MT09LQUhFQURdXHJcbiAgICAgICAgICB0b3RhbFsyXSsrIGlmIHRpbGVtYXBbaStuXVtqLTFdIGlzbnQgdGlsZS5OVUxMXHJcbiAgICAgICAgICB0b3RhbFszXSsrIGlmIHRpbGVtYXBbaStuXVtqKzFdIGlzbnQgdGlsZS5OVUxMXHJcbiAgICAgICMgSWYgbXVzdCBwbGFjZSByb29tXHJcbiAgICAgIGlmICh0b3RhbFswXSA+PSBMT09LQUhFQUQgb3IgdG90YWxbMV0gPj0gTE9PS0FIRUFEIG9yXHJcbiAgICAgICAgICB0b3RhbFsyXSA+PSBMT09LQUhFQUQgb3IgdG90YWxbM10gPj0gTE9PS0FIRUFEKSBhbmRcclxuICAgICAgICAgIHJhbmRvbS50ZXN0KGNmZy5ET09SX0NIQU5DRSlcclxuICAgICAgICB0aWxlbWFwW2ldW2pdID0gdGlsZS5ET09SXHJcbiAgICAgICAgZG9vcnMucHVzaChuZXcgUG9pbnQoaixpKSlcclxuICBkb29yc1xyXG5cclxuc3BsaXQgPSAoc2VjdG9yLCBob3Jpem9udGFsRGlyID0gcmFuZG9tLnRlc3QoKSwgc3RlcHMgPSBjZmcuUEFSVElUSU9OX0xFVkVMKSAtPlxyXG4gICMgU3BsaXQgaG9yaXpvbnRhbGx5XHJcbiAgaWYgaG9yaXpvbnRhbERpclxyXG4gICAgIyBJZiB0b28gbmFycm93IHRvIHNwbGl0IGluIHRoaXMgZGlyZWN0aW9uLCB0cnkgdG8gc3BsaXQgaW4gYW5vdGhlciBvbmVcclxuICAgIGlmIHNlY3Rvci5oL3NlY3Rvci53IDwgMiAqIGNmZy5SQVRJT19SRVNUUlxyXG4gICAgICByZXR1cm4gc3BsaXQoc2VjdG9yLCAhaG9yaXpvbnRhbERpciwgc3RlcHMpXHJcbiAgICAjIElmIHN0b3Agc3BsaXR0aW5nXHJcbiAgICBlbHNlIGlmIChzdGVwcyBpcyAwKSBvciAoc2VjdG9yLmggPCAyKmNmZy5NSU5fU0VDVE9SX1NJWkUpIG9yXHJcbiAgICAgICAgKHNlY3Rvci5oIDwgY2ZnLk1BWF9TRUNUT1JfU0laRSBhbmQgcmFuZG9tLnRlc3QoY2ZnLkJJR19ST09NX0NIQU5DRSkpXHJcbiAgICAgIHJldHVybiBbc2VjdG9yXVxyXG4gICAgIyBGaW5hbGx5IHNwbGl0XHJcbiAgICBlbHNlXHJcbiAgICAgIHJlc3RyaWN0aW9uID0gTWF0aC5tYXgoY2ZnLk1JTl9TRUNUT1JfU0laRSxcclxuICAgICAgICBNYXRoLmNlaWwoc2VjdG9yLmggKiBjZmcuUkFUSU9fUkVTVFIpKVxyXG4gICAgICBkaXYxID0gbmV3IFJlY3Qoc2VjdG9yLngsIHNlY3Rvci55LCBzZWN0b3IudyxcclxuICAgICAgICByYW5kb20udmFsdWUocmVzdHJpY3Rpb24sIHNlY3Rvci5oIC0gcmVzdHJpY3Rpb24pKVxyXG4gICAgICBkaXYyID0gbmV3IFJlY3Qoc2VjdG9yLngsIHNlY3Rvci55ICsgZGl2MS5oLCBzZWN0b3Iudywgc2VjdG9yLmggLSBkaXYxLmgpXHJcbiAgICAjIFNwbGl0IHZlcnRpY2FsbHlcclxuICBlbHNlXHJcbiAgICAjIElmIHRvbyBuYXJyb3cgdG8gc3BsaXQgaW4gdGhpcyBkaXJlY3Rpb24sIHRyeSB0byBzcGxpdCBpbiBhbm90aGVyIG9uZVxyXG4gICAgaWYgc2VjdG9yLncvc2VjdG9yLmggPCAyICogY2ZnLlJBVElPX1JFU1RSXHJcbiAgICAgIHJldHVybiBzcGxpdChzZWN0b3IsICFob3Jpem9udGFsRGlyLCBzdGVwcylcclxuICAgICMgSWYgc3RvcCBzcGxpdHRpbmdcclxuICAgIGVsc2UgaWYgKHN0ZXBzIGlzIDApIG9yIChzZWN0b3IudyA8IDIqY2ZnLk1JTl9TRUNUT1JfU0laRSkgb3JcclxuICAgICAgICAoc2VjdG9yLncgPCBjZmcuTUFYX1NFQ1RPUl9TSVpFIGFuZCByYW5kb20udGVzdChjZmcuQklHX1JPT01fQ0hBTkNFKSlcclxuICAgICAgcmV0dXJuIFtzZWN0b3JdXHJcbiAgICAjIEZpbmFsbHkgc3BsaXRcclxuICAgIGVsc2VcclxuICAgICAgcmVzdHJpY3Rpb24gPSBNYXRoLm1heChjZmcuTUlOX1NFQ1RPUl9TSVpFLFxyXG4gICAgICAgIE1hdGguY2VpbChzZWN0b3IudyAqIGNmZy5SQVRJT19SRVNUUikpXHJcbiAgICAgIGRpdjEgPSBuZXcgUmVjdChzZWN0b3IueCwgc2VjdG9yLnksXHJcbiAgICAgICAgcmFuZG9tLnZhbHVlKHJlc3RyaWN0aW9uLCBzZWN0b3IudyAtIHJlc3RyaWN0aW9uKSwgc2VjdG9yLmgpXHJcbiAgICAgIGRpdjIgPSBuZXcgUmVjdChzZWN0b3IueCArIGRpdjEudywgc2VjdG9yLnksIHNlY3Rvci53IC0gZGl2MS53LCBzZWN0b3IuaClcclxuICBzcGxpdChkaXYxLCAhaG9yaXpvbnRhbERpciwgc3RlcHMtMSkuY29uY2F0KHNwbGl0KGRpdjIsICFob3Jpem9udGFsRGlyLCBzdGVwcy0xKSlcclxuXHJcbiMjIyBFWFBPUlQgIyMjXHJcbkBic3AgPVxyXG4gIGNvbmZpZzogY2ZnXHJcbiAgZ2VuZXJhdGU6IGdlbmVyYXRlTWFwXHJcbiAgVHJlZTogVHJlZVxyXG4iXX0=