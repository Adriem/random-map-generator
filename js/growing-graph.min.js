var Direction,FIRST_ROOM_HEIGHT,FIRST_ROOM_WIDTH,Map,Point,Room,Tile,Tilemap,actualMap,clone,expandRoomFromFrontier,generateInitialState,generateMap,getDoorFlags,getPossibleNeighbours,map,obtainMap,printMap,random;random={test:function(n){return null==n&&(n=.5),1>n?Math.random()<n:100*Math.random()<n},value:function(n,t){return null==t&&(t=n,n=0),n>=t?n:Math.floor(Math.random()*(t-n)+n)},shuffle:function(n){return n}},clone=function(n){return n},Point=function(){function n(n,t){this.x=n,this.y=t,this[0]=n,this[1]=t,this.length=2}return n}(),Tilemap=function(){function n(n,t,o){var e,i;this.width=n,this.height=t,null==o&&(o=null),this.tilemap=function(){var n,t,r;for(r=[],e=n=0,t=this.width;t>=0?t>n:n>t;e=t>=0?++n:--n)r.push(function(){var n,t,e;for(e=[],i=n=0,t=this.height;t>=0?t>n:n>t;i=t>=0?++n:--n)e.push(o);return e}.call(this));return r}.call(this)}return n.prototype.get=function(n,t){var o,e,i,r,u;if(null==t)return this.tilemap[n[0]][n[1]];if(typeof n==(e=typeof t)&&"number"===e)return this.tilemap[n][t];for(u=[],n=o=i=n[0],r=t[0];r>=i?r>=o:o>=r;n=r>=i?++o:--o)u.push(function(){var o,e,i,r;for(r=[],t=o=e=n[1],i=t[1];i>=e?i>=o:o>=i;t=i>=e?++o:--o)r.push(this.tilemap[n][t]);return r}.call(this));return u},n.prototype.set=function(n,t,o){var e,i,r,u,l,a,s;if(null==o)return this.tilemap[n[0]][n[1]]=t;if(null==t)return this.tilemap[n[0]][n[1]]=o;if(typeof n==(u=typeof t)&&"number"===u)return this.tilemap[n][t]=o;for(s=[],e=r=l=n[0],a=t[0];a>=l?a>=r:r>=a;e=a>=l?++r:--r)s.push(function(){var r,u,l,a;for(a=[],i=r=u=n[1],l=t[1];l>=u?l>=r:r>=l;i=l>=u?++r:--r)a.push(this.tilemap[e][i]=o);return a}.call(this));return s},n.prototype.is=function(n,t,o){var e,i,r,u,l,a,s,h,p;if(null==o)return this.tilemap[n[0]][n[1]]===t;if(null==t)return this.tilemap[n[0]][n[1]]===o;if(typeof n==(l=typeof t)&&"number"===l)return this.tilemap[n][t]=o;for(e=r=a=n[0],s=t[0];s>=a?s>=r:r>=s;e=s>=a?++r:--r)for(i=u=h=n[1],p=t[1];p>=h?p>=u:u>=p;i=p>=h?++u:--u)if(this.tilemap[e][i]!==o)return!1;return!0},n}(),getDoorFlags=function(n){return{north:n%4===0,south:n%4===2,east:n%4===1,west:n%4===3,up:4>n&&n%2===1,left:4>n&&n%2===0,down:n>4&&n%2===1,right:n>4&&n%2===0}},getPossibleNeighbours=function(n,t,o){var e,i,r,u,l,a,s,h;for(r=getDoorFlags(n),s=r.north?new Point(t.p1[0]+Math.floor(n/4),t.p1[1]):r.south?new Point(t.p1[0]+Math.floor(n/4),t.p2[1]):r.east?new Point(t.p2[0],t.p1[1]+Math.floor(n/4)):r.west?new Point(t.p1[0],t.p1[1]+Math.floor(n/4)):void 0,r.north?i=[new Room(new Point(s[0],s[1]-1),new Point(s[0],s[1]-1),function(){var n,o;for(o=[],u=n=0;3>=n;u=++n)o.push(2===u?t:null);return o}()),new Room(new Point(s[0]-1,s[1]-1),new Point(s[0],s[1]-1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(6===u?t:null);return o}()),new Room(new Point(s[0],s[1]-1),new Point(s[0]+1,s[1]-1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(2===u?t:null);return o}()),new Room(new Point(s[0],s[1]-2),new Point(s[0],s[1]-1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(2===u?t:null);return o}()),new Room(new Point(s[0]-1,s[1]-2),new Point(s[0],s[1]-1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(6===u?t:null);return o}()),new Room(new Point(s[0],s[1]-2),new Point(s[0]+1,s[1]-1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(2===u?t:null);return o}())]:r.south?i=[new Room(new Point(s[0],s[1]+1),new Point(s[0],s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(0===u?t:null);return o}()),new Room(new Point(s[0]-1,s[1]+1),new Point(s[0],s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(4===u?t:null);return o}()),new Room(new Point(s[0],s[1]+1),new Point(s[0]+1,s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(0===u?t:null);return o}()),new Room(new Point(s[0],s[1]+1),new Point(s[0],s[1]+2),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(0===u?t:null);return o}()),new Room(new Point(s[0]-1,s[1]+1),new Point(s[0],s[1]+2),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(4===u?t:null);return o}()),new Room(new Point(s[0],s[1]+1),new Point(s[0]+1,s[1]+2),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(0===u?t:null);return o}())]:r.east?i=[new Room(new Point(s[0]+1,s[1]),new Point(s[0]+1,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(3===u?t:null);return o}()),new Room(new Point(s[0]+1,s[1]-1),new Point(s[0]+1,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(7===u?t:null);return o}()),new Room(new Point(s[0]+1,s[1]),new Point(s[0]+1,s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(3===u?t:null);return o}()),new Room(new Point(s[0]+1,s[1]),new Point(s[0]+2,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(3===u?t:null);return o}()),new Room(new Point(s[0]+1,s[1]-1),new Point(s[0]+2,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(7===u?t:null);return o}()),new Room(new Point(s[0]+1,s[1]),new Point(s[0]+2,s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(3===u?t:null);return o}())]:r.west&&(i=[new Room(new Point(s[0]-1,s[1]),new Point(s[0]-1,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(1===u?t:null);return o}()),new Room(new Point(s[0]-1,s[1]-1),new Point(s[0]-1,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(5===u?t:null);return o}()),new Room(new Point(s[0]-1,s[1]),new Point(s[0]-1,s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(1===u?t:null);return o}()),new Room(new Point(s[0]-2,s[1]),new Point(s[0]-1,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(1===u?t:null);return o}()),new Room(new Point(s[0]-2,s[1]-1),new Point(s[0]-1,s[1]),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(5===u?t:null);return o}()),new Room(new Point(s[0]-2,s[1]),new Point(s[0]-1,s[1]+1),function(){var n,o;for(o=[],u=n=0;7>=n;u=++n)o.push(1===u?t:null);return o}())]),h=[],l=0,a=i.length;a>l;l++)e=i[l],o.is(e.p1,e.p2,Tile.EMPTY)&&h.push(e);return h},FIRST_ROOM_WIDTH=1,FIRST_ROOM_HEIGHT=1,Tile={EMPTY:0,OCCUPIED:1,WALL:-1,DOOR:-2,FIRST_ROOM:1},Direction={NORTH:0,EAST:1,SOUTH:2,WEST:3},Room=function(){function n(n,t,o){var e;this.p1=new Point(Math.min(n[0],t[0]),Math.min(n[1],t[1])),this.p2=new Point(Math.max(n[0],t[0]),Math.max(n[1],t[1])),this.neighbours=null!=o?o:function(){var n,t;for(t=[],e=n=0;8>n;e=++n)t.push(null);return t}()}return n.prototype.getExits=function(){var n;return[].push(function(){var t,o,e;for(e=[],n=t=0,o=this.p2[0]-this.p1[0];o>=0?o>=t:t>=o;n=o>=0?++t:--t)e.push((Direction.NORTH+4*n,Direction.SOUTH+4*n));return e}.call(this),function(){var t,o,e;for(e=[],n=t=0,o=this.p2[1]-this.p1[1];o>=0?o>=t:t>=o;n=o>=0?++t:--t)e.push((Direction.EAST+4*n,Direction.WEST+4*n));return e}.call(this))},n.prototype.hasExit=function(n){return(n%4===Direction.NORTH||n%4===Direction.SOUTH)&&Math.floor(n/4)<=this.p2[0]-this.p1[0]||(n%4===Direction.EAST||n%4===Direction.WEST)&&Math.floor(n/4)<=this.p2[1]-this.p1[1]},n.prototype.getAvailableExits=function(){var n,t,o,e,i,r;for(i=this.neighbours,r=[],n=t=0,o=i.length;o>t;n=++t)e=i[n],this.hasExit(n)&&null==e&&r.push(n);return r},n.prototype.getUnlinkedVersion=function(){var t;return new n(this.p1,this.p2,function(){var n,o,e,i;for(e=this.neighbours,i=[],n=0,o=e.length;o>n;n++)t=e[n],i.push(null!=t?!0:null);return i}.call(this))},n.prototype.isContainedIn=function(n){var t,o,e;for(o=0,e=n.length;e>o;o++)if(t=n[o],t.p1[0]===this.p1[0]&&t.p1[1]===this.p1[1]&&t.p2[0]===this.p2[0]&&t.p2[1]===this.p2[1])return!0;return!1},n}(),Map=function(){function n(n,t,o){this.width=n,this.height=t,this.roomList=o}var t;return n.prototype.getRoomList=function(n,t){var o;return null==n&&(n=this.originRoom),null==t&&(t=[]),t.push(n),[n].push(function(){var e,i,r,u;for(r=n.neighbours,u=[],e=0,i=r.length;i>e;e++)o=r[e],null!=o&&-1!==t.indexOf(o)&&u.push(this.getRoomList(o,t));return u}.call(this))},n.prototype.getTileMap=function(n){var o,e,i,r,u,l;for(n++,l=new Tilemap(this.width*n+1,this.height*n+1,Tile.EMPTY),r=this.roomList,o=e=0,i=r.length;i>e;o=++e)u=r[o],t(u,l,n);return l},t=function(n,t,o){var e,i,r,u,l,a,s,h,p;for(a=new Point(n.p1[0]*o,n.p1[1]*o),s=new Point((n.p2[0]+1)*o-1,(n.p2[1]+1)*o-1),t.set(new Point(a[0]+1,a[1]+1),s,Tile.OCCUPIED),t.set(new Point(a[0],a[1]),new Point(s[0]+1,a[1]),Tile.WALL),t.set(new Point(a[0],s[1]+1),new Point(s[0]+1,s[1]+1),Tile.WALL),t.set(new Point(s[0]+1,a[1]),new Point(s[0]+1,s[1]+1),Tile.WALL),t.set(new Point(a[0],a[1]),new Point(a[0],s[1]+1),Tile.WALL),h=n.neighbours,p=[],e=r=0,u=h.length;u>r;e=++r)l=h[e],i=Math.floor(e/4)*o+Math.floor(o/2),p.push(null!=l&&e%4===Direction.NORTH?t.set(new Point(a[0]+i,a[1]),Tile.DOOR):null!=l&&e%4===Direction.SOUTH?t.set(new Point(a[0]+i,s[1]+1),Tile.DOOR):null!=l&&e%4===Direction.EAST?t.set(new Point(s[0]+1,a[1]+i),Tile.DOOR):null!=l&&e%4===Direction.WEST?t.set(new Point(a[0],a[1]+i),Tile.DOOR):void 0);return p},n}(),generateInitialState=function(n,t,o,e){var i,r,u,l,a,s;return u=new Point(random.value(.4*n,.6*n),random.value(.4*t,.6*t)),l=new Point(u[0]+o-1,u[1]+e-1),r=new Room(u,l),s=new Tilemap(n,t,Tile.EMPTY),s.set(u,l,Tile.FIRST_ROOM),i=[r],a=[r],{roomList:a,tilemap:s,frontier:i,steps:0}},expandRoomFromFrontier=function(n,t){var o,e,i,r,u,l,a,s;for(s=clone(n),a=s.frontier.shift(),l=random.shuffle(a.getAvailableExits()),i=0,r=l.length;r>i;i++)e=l[i],s.remainingRooms>0&&(o=getPossibleNeighbours(e,a,s.tilemap),o.length>0&&(u=o[random.value(0,o.length)],a.neighbours[e]=u,s.roomList.push(u),s.frontier.push(u),s.tilemap.set(u.p1,u.p2,++s.steps),s.remainingRooms--,null!=t&&t(s)));return s},generateMap=function(n,t,o,e){var i;for(null==o&&(o=10),i=generateInitialState(n,t,1,1),i.remainingRooms=o,null!=e&&e(i);i.remainingRooms>0;)i=expandRoomFromFrontier(i,e);return i},obtainMap=function(n){return new Map(n.tilemap.width,n.tilemap.height,n.roomList)},printMap=function(n){var t,o,e,i,r,u,l,a,s;for(r=[],s=t=0,e=n.height;e>=0?e>t:t>e;s=e>=0?++t:--t){for(u="",a=o=0,i=n.width;i>=0?i>o:o>i;a=i>=0?++o:--o)l=n.get(a,s),u+=function(){switch(l){case Tile.EMPTY:return"··";case Tile.WALL:return"##";case Tile.DOOR:return"[]";default:return"  "}}();r.push(console.log(u))}return r},map=generateMap(10,10,15,function(n){var t;return t=obtainMap(n).getTileMap(1),printMap(t)}),actualMap=obtainMap(map).getTileMap(3),printMap(actualMap);