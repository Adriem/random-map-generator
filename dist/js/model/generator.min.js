var Defaults,Generator,Room,State,callCallback,generate,indexOf=[].indexOf||function(t){for(var i=0,e=this.length;e>i;i++)if(i in this&&this[i]===t)return i;return-1};Defaults={MAP_SIZE:10,NUMBER_OF_ROOMS:15,TILES_PER_UNIT:3,INITIAL_ROOM_WIDTH:1,INITIAL_ROOM_HEIGHT:1,MIN_ROOM_SIZE:1,MAX_ROOM_SIZE:2,MIN_ROOM_AREA:1,MAX_ROOM_AREA:6,RATIO_RESTRICTION:.5},Room=function(){function t(t,i,e,o,n,r,h){this.x=t,this.y=i,this.width=e,this.height=o,this.id=n,this.attrs=null!=r?r:{},this.neighbours=null!=h?h:[]}return t.prototype.getExits=function(){var t;return[].concat(function(){var i,e,o;for(o=[],t=i=0,e=this.width;e>=0?e>i:i>e;t=e>=0?++i:--i)o.push(Direction.NORTH+4*t);return o}.call(this),function(){var i,e,o;for(o=[],t=i=0,e=this.width;e>=0?e>i:i>e;t=e>=0?++i:--i)o.push(Direction.SOUTH+4*t);return o}.call(this),function(){var i,e,o;for(o=[],t=i=0,e=this.height;e>=0?e>i:i>e;t=e>=0?++i:--i)o.push(Direction.EAST+4*t);return o}.call(this),function(){var i,e,o;for(o=[],t=i=0,e=this.height;e>=0?e>i:i>e;t=e>=0?++i:--i)o.push(Direction.WEST+4*t);return o}.call(this))},t.prototype.getAvailableExits=function(){var t,i,e,o,n;for(o=this.getExits(),n=[],i=0,e=o.length;e>i;i++)t=o[i],null==this.neighbours[t]&&n.push(t);return n},t.prototype.getArea=function(){return this.width*this.height},t.prototype.collidesWith=function(t){return!(this.x>t.x+t.width||t.x>this.x+this.width||this.y>t.y+t.height||t.y>this.y+this.height)},t.prototype.clone=function(){var i,e,o,n,r,h;i={},r=this.attrs;for(e in r)h=r[e],i[e]=h;return n=function(){var t,i,e,n;for(e=this.neighbours,n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push(o);return n}.call(this),new t(this.x,this.y,this.width,this.height,this.id,i,n)},t}(),State=function(){function t(t,i,e,o){this.rooms=null!=t?t:[],this.frontier=null!=i?i:[],null!=e&&null!=o&&(this.collisionMap=new Tilemap(e,o,!1))}return t.prototype.getSteps=function(){return this.rooms.length-1},t.prototype.addRoom=function(t){return this.rooms.push(t),this.frontier.push(t),null!=this.collisionMap?this.collisionMap.set(t.x,t.y,t.width,t.height,!0):void 0},t.prototype.hasRoomFor=function(t){var i,e,o,n;if(null!=this.collisionMap)return this.collisionMap.is(t.x,t.y,t.width,t.height,!1);for(n=this.rooms,i=0,e=n.length;e>i;i++)if(o=n[i],o.collidesWith(t))return!1;return!0},t.prototype.clone=function(){var i,e;return i=new t(function(){var t,i,o,n;for(o=this.rooms,n=[],t=0,i=o.length;i>t;t++)e=o[t],n.push(e.clone());return n}.call(this),function(){var t,i,o,n;for(o=this.frontier,n=[],t=0,i=o.length;i>t;t++)e=o[t],n.push(e.clone());return n}.call(this)),null!=this.collisionMap&&(i.collisionMap=this.collisionMap.clone()),i},t}(),Generator=function(){function t(t,i){var e,o,n,r,h,s,a,l,u;this.remainingRooms=t,this.minRoomSize=null!=(e=i.minRoomSize)?e:Defaults.MIN_ROOM_SIZE,this.maxRoomSize=null!=(o=i.maxRoomSize)?o:Defaults.MAX_ROOM_SIZE,this.minRoomArea=null!=(n=i.minRoomArea)?n:Math.pow(this.minRoomSize,2),this.maxRoomArea=null!=(r=i.maxRoomArea)?r:Math.pow(this.maxRoomSize,2),this.ratioRestr=null!=(h=i.ratioRestriction)?h:0,this.mapWidth=null!=(s=i.width)?s:this.maxRoomSize*t,this.mapHeight=null!=(a=i.height)?a:this.maxRoomSize*t,this.initialRoomWidth=null!=(l=i.initialRoomWidth)?l:Defaults.INITIAL_ROOM_WIDTH,this.initialRoomHeight=null!=(u=i.initialRoomHeight)?u:Defaults.INITIAL_ROOM_HEIGHT}var i,e;return t.prototype.generateInitialRoom=function(){var t,i;return t=random.value(.3*this.mapWidth,.7*this.mapWidth),i=random.value(.3*this.mapHeight,.7*this.mapHeight),new Room(t,i,this.initialRoomWidth,this.initialRoomHeight,0)},t.prototype.generateInitialState=function(){return new State([],[],this.mapWidth,this.mapHeight)},t.prototype.generateNeighbour=function(t,i,o){var n,r,h,s,a,l,u;if(r=this.generatePossibleNeighbours(t,i,o),r.length>0&&random.test(e(o))){for(n=[],h=[],s=0,a=r.length;a>s;s++)t=r[s],l=t.getArea(),indexOf.call(n,l)<0&&(n.push(t.getArea()),h[n.indexOf(t.getArea())]=[]),h[n.indexOf(t.getArea())].push(t);return u=h[random.value(0,h.length)],u[random.value(0,u.length)]}},t.prototype.generatePossibleNeighbours=function(t,e,o){var n,r,h,s,a,l,u,c,m,f,p,g,R,d,M,O,S,I;for(r=[],s=a=f=this.minRoomSize,p=this.maxRoomSize;p>=f?p>=a:a>=p;s=p>=f?++a:--a)for(O=l=g=this.minRoomSize,R=this.maxRoomSize;R>=g?R>=l:l>=R;O=R>=g?++l:--l)if(this.validMeasures(O,s))for(m=e%2===0?O:s,c=u=d=1-m;0>=d?0>=u:u>=0;c=0>=d?++u:--u)M=function(){switch(e%4){case Direction.NORTH:return[t.x+Math.floor(e/4)+c,t.y-s];case Direction.SOUTH:return[t.x+Math.floor(e/4)+c,t.y+t.height];case Direction.EAST:return[t.x+t.width,t.y+Math.floor(e/4)+c];case Direction.WEST:return[t.x-O,t.y+Math.floor(e/4)+c]}}(),S=M[0],I=M[1],n=new Room(S,I,O,s,o.getSteps()+1),h=4*c*-1+i(e),n.neighbours[h]=t.id,o.hasRoomFor(n)&&r.push(n);return r},t.prototype.validMeasures=function(t,i){return i*t<=this.maxRoomArea&&i*t>=this.minRoomArea&&t/i>=this.ratioRestr&&i/t>=this.ratioRestr},i=function(t){return(t%4+2)%4},e=function(t){return 0===t.frontier.length?100:75},t}(),generate=function(t,i,e){var o,n,r,h,s,a,l,u,c,m;for(n=new Generator(t,i),r=n.generateInitialRoom(),m=n.generateInitialState(),m.addRoom(r),u=t-1,callCallback(n,m,e);u>0&&m.frontier.length>0;)for(c=m.frontier.shift(),l=random.shuffle(c.getAvailableExits()),h=0,s=l.length;s>h;h++)o=l[h],u>0&&(m=m.clone(),c=m.rooms[c.id],a=n.generateNeighbour(c,o,m),null!=a&&(c.neighbours[o]=a.id,m.addRoom(a),u--,callCallback(n,m,e)));return new Map(n.mapWidth,n.mapHeight,m.clone().rooms)},callCallback=function(t,i,e){return null!=e?e(new Map(t.mapWidth,t.mapHeight,i.clone().rooms),i.getSteps()):void 0},window.generate=generate;