var hasProp={}.hasOwnProperty;this.mapParams={mapSize:50,canvasSize:400,showGrid:!0,showDoors:!0,showWalls:!0,debugMode:!1},this.TILE_SIZE=function(){return mapParams.canvasSize/mapParams.mapSize},this.color={GRID:"#444",BACKGROUND:"#000",WALL:"#833",GROUND:"#CCC",DOOR:"#66B",DEBUG:"#0F0"},this.tile={NULL:-1,GROUND:0,DOOR:1,WALL:2,DEBUG:-128},this.random={test:function(t){return null==t&&(t=.5),1>t?Math.random()<t:100*Math.random()<t},value:function(t,i){return null==i&&(i=t,t=0),t>=i?t:Math.floor(Math.random()*(i-t)+t)}},this.Point=function(){function t(t,i){this.x=t,this.y=i}return t}(),this.Rect=function(){function t(t,i,e,a){this.x=t,this.y=i,this.w=e,this.h=a,this.center=new Point(this.x+Math.floor(this.w/2),this.y+Math.floor(this.h/2))}return t}(),this.Path=function(){function t(t,i){this.start=t,this.end=i}return t}(),this.TileMap=function(){function t(t,i){var e,a,l,r,s,o;for(this.w=t,this.h=i,this.debug={},this.tilemap=[],e=l=0,s=this.h;s>=0?s>l:l>s;e=s>=0?++l:--l)for(this.tilemap[e]=[],a=r=0,o=this.w;o>=0?o>r:r>o;a=o>=0?++r:--r)this.tilemap[e][a]=tile.NULL}return t.prototype.drawPoint=function(t,i){return null==i&&(i=tile.GROUND),this.tilemap[t.y][t.x]=i},t.prototype.drawRect=function(t,i){var e,a,l,r,s,o;for(null==i&&(i=tile.GROUND),o=[],e=l=r=t.y,s=t.y+t.h;s>=r?s>l:l>s;e=s>=r?++l:--l)o.push(function(){var l,r,s,o;for(o=[],a=l=r=t.x,s=t.x+t.w;s>=r?s>l:l>s;a=s>=r?++l:--l)o.push(this.tilemap[e][a]=i);return o}.call(this));return o},t.prototype.drawPath=function(t,i){var e,a,l,r,s,o,h,n,p,m,f;for(null==i&&(i=tile.GROUND),n=t.start.x<t.end.x?t.start.x:t.end.x,p=t.start.x<t.end.x?t.end.x:t.start.x,m=t.start.y<t.end.y?t.start.y:t.end.y,f=t.start.y<t.end.y?t.end.y:t.start.y,e=a=r=m,s=f;s>=r?s>=a:a>=s;e=s>=r?++a:--a)this.tilemap[e][t.start.x]=i;for(e=l=o=n,h=p;h>=o?h>=l:l>=h;e=h>=o?++l:--l)this.tilemap[t.end.y][e]=i;return void 0},t.prototype.removeDeadEnds=function(){var t,i,e,a,l,r,s,o,h;for(l=e=1,o=this.tilemap.length-1;o>=1?o>e:e>o;l=o>=1?++e:--e)for(r=a=1,h=this.tilemap.length-1;h>=1?h>a:a>h;r=h>=1?++a:--a)if(this.tilemap[l][r]!==tile.NULL)for(i={i:l,j:r};null!=i;)s={},t=0,this.tilemap[i.i-1][i.j]!==tile.NULL&&(t++,s.i=i.i-1,s.j=i.j),this.tilemap[i.i+1][i.j]!==tile.NULL&&(t++,s.i=i.i+1,s.j=i.j),this.tilemap[i.i][i.j-1]!==tile.NULL&&(t++,s.i=i.i,s.j=i.j-1),this.tilemap[i.i][i.j+1]!==tile.NULL&&(t++,s.i=i.i,s.j=i.j+1),t>1?i=null:(this.tilemap[i.i][i.j]=tile.NULL,i=s);return void 0},t.prototype.optimiseDoors=function(){var t,i,e,a,l,r,s,o,h,n;for(t=e=1,l=this.tilemap.length-1;l>=1?l>e:e>l;t=l>=1?++e:--e)for(i=a=1,r=this.tilemap.length-1;r>=1?r>a:a>r;i=r>=1?++a:--a)this.tilemap[t][i]!==tile.NULL&&(this.tilemap[t-1][i]===(s=this.tilemap[t+1][i])&&s===tile.DOOR&&this.tilemap[t][i-1]===(o=this.tilemap[t][i+1])&&o===tile.NULL&&(this.tilemap[t-1][i]=tile.GROUND,this.tilemap[t][i]=tile.DOOR,this.tilemap[t+1][i]=tile.GROUND),this.tilemap[t][i-1]===(h=this.tilemap[t][i+1])&&h===tile.DOOR&&this.tilemap[t-1][i]===(n=this.tilemap[t+1][i])&&n===tile.NULL&&(this.tilemap[t][i-1]=tile.GROUND,this.tilemap[t][i]=tile.DOOR,this.tilemap[t][i+1]=tile.GROUND));return void 0},t.prototype.drawWalls=function(){var t,i,e,a,l,r,s,o,h,n;for(t=e=1,h=this.tilemap.length-1;h>=1?h>e:e>h;t=h>=1?++e:--e)for(i=a=1,n=this.tilemap.length-1;n>=1?n>a:a>n;i=n>=1?++a:--a)if(this.tilemap[t][i]!==tile.NULL&&this.tilemap[t][i]!==tile.WALL)for(r=s=-1;1>=s;r=++s)for(l=o=-1;1>=o;l=++o)this.tilemap[t+l][i+r]===tile.NULL&&(this.tilemap[t+l][i+r]=tile.WALL);return void 0},t.prototype.paintGrid=function(t){var i,e,a,l;for(l=TILE_SIZE(),t.beginPath(),t.strokeStyle=color.GRID,t.lineWidth=1,i=e=0,a=this.w;a>=0?a>e:e>a;i=a>=0?++e:--e)t.moveTo(i*l,0),t.lineTo(i*l,mapParams.mapSize*l),t.moveTo(0,i*l),t.lineTo(mapParams.mapSize*l,i*l);return t.stroke(),t.closePath()},t.prototype.paint=function(t){var i,e,a,l,r,s,o,h,n,p,m,f,u,c,L;for(c=TILE_SIZE(),t.fillStyle=color.BACKGROUND,t.fillRect(0,0,mapParams.canvasSize,mapParams.canvasSize),n=this.tilemap,e=l=0,o=n.length;o>l;e=++l)for(u=n[e],p=this.tilemap[e],a=s=0,h=p.length;h>s;a=++s){switch(i=p[a],this.tilemap[e][a]){case tile.GROUND:t.fillStyle=color.GROUND;break;case tile.DOOR:t.fillStyle=mapParams.showDoors?color.DOOR:color.GROUND;break;case tile.WALL:t.fillStyle=mapParams.showWalls?color.WALL:color.BACKGROUND;break;case tile.DEBUG:t.fillStyle=mapParams.debugMode?color.DEBUG:color.BACKGROUND;break;default:t.fillStyle=color.BACKGROUND}t.fillRect(a*c,e*c,c,c)}if(mapParams.showGrid&&this.paintGrid(t),mapParams.debugMode){m=this.debug,f=[];for(r in m)hasProp.call(m,r)&&(L=m[r],f.push(L.paint(t)));return f}},t}();